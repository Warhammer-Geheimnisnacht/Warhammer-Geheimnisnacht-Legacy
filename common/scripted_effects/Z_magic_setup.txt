magic_targeting_setup = {

}

spell_points_refresh = {
	magic_points_setup = yes
	if = {
		limit = {
			not = {
				check_variable = {which ="spell_power" which = "caster_level"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "spell_power" which = "dresult"}
	}
}

spell_points_bolster = {
	magic_points_setup = yes
	set_variable = { which = "dnum" value = "1"}
	z_d4 = yes
	change_variable ={ which = "dresult" which = "spell_power_mod"}
	change_variable = { which = "spell_power" which = "dresult"}
}


magic_points_setup = {
	set_variable = { which = "spell_power_mod" value = 0}
	set_variable = { which = miscastroll value = 2}
	set_variable = { which = "caster_level" value = 0 }
	set_variable = { which = "caster_level_dispel" value = 0 }
	set_variable = { which = "caster_level_miscast" value = 0 }
	set_variable = { which = "caster_level_spellpower" value = 0 }
	set_variable = { which = "magical_resistance" value = 0 }
	set_variable = { which = "magical_penetration" value = 0 }
	set_variable = { which = "caster_level" which = "cl"}
	if = {
		limit = {
			has_artifact = mages_crown
		}
		change_variable = { which = "caster_level" value = 1}
	}
	if = {
		limit = {
			has_character_modifier = z_liege_boost_1
		}
		change_variable = { which = "caster_level" value = 1}
		remove_character_modifier = z_liege_boost_1
	}
	if = {
		limit = {
			has_character_modifier = z_liege_boost_2
		}
		change_variable = { which = "caster_level" value = 2}
		remove_character_modifier = z_liege_boost_2
	}
	if = {
		limit = {
			has_character_modifier = z_liege_boost_3
		}
		change_variable = { which = "caster_level" value = 3}
		remove_character_modifier = z_liege_boost_3
	}
	if = {
		limit = {
			or = {
				trait = creature_slann
				trait = skink_priest
			}
			has_artifact = stegadon_mount
		}
		change_variable = { which = "caster_level" value = 1}
	}
	if = {
		limit = {
			trait = creature_slann
		}
		change_variable = { which = "caster_level" value = 4}
		change_variable = { which = miscastroll value = 2}
	}
	set_variable = { which = "spell_power_mod" which = "caster_level"}
	set_variable = { which = "caster_level_dispel" which = "caster_level"}
	set_variable = { which = "caster_level_miscast" which = "caster_level"}
	set_variable = { which = "caster_level_spellpower" which = "caster_level"}
	change_variable = { which = "magical_resistance" which = "caster_level"}
	change_variable = { which = "magical_penetration" which = "caster_level"}

	if = {
		limit = {
			trait = warlock_engineer
		}
		set_variable = { which = "caster_level" value = 1}
		set_variable = { which = "caster_level_miscast" value = 1}
		set_variable = { which = "caster_level_dispel" value = 1}
		set_variable = { which = "caster_level_spellpower" value = 1}
	}

    change_variable = { which = duledmgdicebase value = 1}
    change_variable = { which = dmgmod value = 2}
	if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_staff_1
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_spellpower" value = 1}
    }
    if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_staff_2
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_spellpower" value = 2}
    }
	if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_staff_3
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_spellpower" value = 3}
    }
	if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_amulet_1
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_miscast" value = 1}
    }
	if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_amulet_2
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_miscast" value = 2}
    }
	if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_amulet_3
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_miscast" value = 3}
    }

	if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_ring_1
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_dispel" value = 1}
    }
    if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_ring_2
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_dispel" value = 2}
    }
    if = {
    	limit = {
      		random_artifact = {
        		artifact_type = mages_ring_3
        		is_artifact_equipped = yes
      		}
      	}
      	change_variable = { which = "caster_level_dispel" value = 3}
    }

	change_variable = {	which = "spell_power_mod" which = "warpcrack"}
	if = {
		limit = {
			trait = loremaster
		}
		change_variable = { which = "spell_power_mod" value = 8}
		change_variable = { which = "caster_level_dispel" value = 1}
		change_variable = { which = "caster_level_miscast" value = 1}
	}
	if = {
		limit = {
			or = {
				trait = avatar_isha
				trait = avatar_kurnous
				trait = everqueen
				trait = malekith
			}
		}
		change_variable = { which = "magical_resistance" value = 30}
	}
	if = {
		limit = {
			trait = creature_slann
		}
		change_variable = { which = "magical_resistance" value = 30}
	}
	if = {
		limit = {
			or = {
				culture_group = dwarf_group
				culture_group = dwarf_chaos_group
			}
		}
		change_variable = { which = "magical_resistance" value = 10}
	}
	if = {
		limit = {
			trait = hedge_wizard
		}
		change_variable = { which = "magical_resistance" value = -5}
	}
	if = {
		limit = {
			has_character_modifier = z_light_magic_wards_of_light
		}
		change_variable = { which = "caster_level_dispel" value = 9 }
	}
	if = {
    	limit = {
            has_instances_of_character_modifier = { modifier = magic_drain amount = 1 }
        }
        while = {
			limit = {
				check_variable = { which = caster_level value = 1	}
				has_instances_of_character_modifier = { modifier = magic_drain amount = 1 }
			}
        	change_variable = {which = "caster_level" value = "-1"}
        	change_variable = {which = "spell_power_mod" value = "-2"}
        	remove_character_modifiers = { modifier = magic_drain amount = 1 }
        }
    }
}

magic_spells_known = {
	set_variable = { which = "spellknownlvl" value = 0  }
	change_variable = { which = "spellknownlvl" which = "caster_level" }
	change_variable = { which = "spellknownlvl" which = "warpcrack" }
}

spellcastmod_calc = {
	set_variable = { which = spellcastmod value = 0}
	if = {
    	limit = {
    		has_character_modifier = magic_lore_heavens_foresight
    	}
       	change_variable = {which = "spellcastmod" value = -2}
    }

}

magic_item_proc = {
	if = {
		limit = {
			random_artifact = {
        		artifact_type = mages_tome
        		is_artifact_equipped = yes
      		}
		}
		random = {
			chance = 25
			random_list = {
				5 = {
					change_variable = { which = "spell_power" value = 1}
				}
				1 = {
					change_variable = { which = "spell_power" value = 2}
				}
			}
		}
	}
}



z_spell_process	= {
	if = {
		limit = {
			event_target:magic_caster = {
				has_character_flag = dispeled
			}
		}
		event_target:magic_caster = { clr_character_flag = dispeled}
		character_event = { id = z_spell_menu.99999}
	}
	if = {
		limit = {
			event_target:magic_caster = { has_character_flag = miscast }
		}
		character_event = {id = magic_system.99991}#If has the miscast flag, skip to the miscast event table
	}
	if = {
		limit = {
			event_target:magic_caster = { has_character_flag = spell_fail }
		}
		character_event = {id = z_spell_menu.99992}#If has the miscast flag, skip to the miscast event table
		event_target:magic_caster = { clr_character_flag = spell_fail}
	}
}


z_spell_process_non_combat = {
	if = {
		limit = {
			event_target:magic_caster = {
				has_character_flag = dispeled
			}
		}
		event_target:magic_caster = { clr_character_flag = dispeled}
		character_event = { id = z_spell_menu.99996}
	}
	if = {
		limit = {
			event_target:magic_caster = { has_character_flag = miscast }
		}
		character_event = {id = magic_system.99991}#If has the miscast flag, skip to the miscast event table
	}
	if = {
		limit = {
			event_target:magic_caster = { has_character_flag = spell_fail }
		}
		character_event = {id = z_spell_menu.99992}#If has the miscast flag, skip to the miscast event table
		event_target:magic_caster = { clr_character_flag = spell_fail}
	}
}
